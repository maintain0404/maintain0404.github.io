<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ASGI 깊게 살펴보기 | Taein.dev</title>
<meta name=keywords content="python,ASGI"><meta name=description content="ASGI 도입 배경과 프로토콜을 깊게 분석해봅니다."><meta name=author content="Me"><link rel=canonical href=https://maintain0404.github.io/posts/asgi_deep_dive.ko/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://maintain0404.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://maintain0404.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://maintain0404.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://maintain0404.github.io/apple-touch-icon.png><link rel=mask-icon href=https://maintain0404.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-HBTP6KYQ2X"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-HBTP6KYQ2X",{anonymize_ip:!1})}</script><meta property="og:title" content="ASGI 깊게 살펴보기"><meta property="og:description" content="ASGI 도입 배경과 프로토콜을 깊게 분석해봅니다."><meta property="og:type" content="article"><meta property="og:url" content="https://maintain0404.github.io/posts/asgi_deep_dive.ko/"><meta property="og:image" content="https://maintain0404.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-24T21:03:30+09:00"><meta property="article:modified_time" content="2023-12-24T21:03:30+09:00"><meta property="og:site_name" content="Taein.dev"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maintain0404.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ASGI 깊게 살펴보기"><meta name=twitter:description content="ASGI 도입 배경과 프로토콜을 깊게 분석해봅니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://maintain0404.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ASGI 깊게 살펴보기","item":"https://maintain0404.github.io/posts/asgi_deep_dive.ko/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ASGI 깊게 살펴보기","name":"ASGI 깊게 살펴보기","description":"ASGI 도입 배경과 프로토콜을 깊게 분석해봅니다.","keywords":["python","ASGI"],"articleBody":"개요 이 글에서는 ASGI 도입 배경과 프로토콜을 분석해봅니다. 추가적으로 ASGI 프로토콜 서버 구현을 살펴보면서 ASGI의 필요성을 따져봅니다. 아래 지식을 가지고 있으면 이 글을 읽는 데에 도움이 됩니다.\nPython 문법(3.12 기준) 비동기 프로그래밍과 코루틴 HTTP 기타 서버 개발 관련 지식 WSGI를 두고 ASGI를 새로 만든 이유 WSGI(Web Server Gateway Interface)는 ASGI 이전에 사용하던 Python의 웹 서버와 웹 애플리케이션 프레임워크 간의 인터페이스입니다. 이전의 프로토콜의 버전 업그레이드가 아니라 새롭게 인터페이스를 정의한 이유는 무엇일까요? ASGI 공식 문서에서는 다음과 같이 설명하고 있습니다.\nThe WSGI specification has worked well since it was introduced, and allowed for great flexibility in Python framework and web server choice. However, its design is irrevocably tied to the HTTP-style request/response cycle, and more and more protocols that do not follow this pattern are becoming a standard part of web programming (most notably, WebSocket). ASGI attempts to preserve a simple application interface, while providing an abstraction that allows for data to be sent and received at any time, and from different application threads or processes.\n줄이자면 기존의 WSGI는 HTTP 스타일의 요청-응답 구조에 너무 맞춰져 있어서 새로운 웹 트렌드 변화(Websocket, HTTP/2)에 대응하기 어렵다는 것입니다 한 번 WSGI 구조를 살펴보겠습니다. 아래는 WSGI 문서를 참조해서 프로토콜을 type hint로 작성한 예시입니다.\nfrom typing import * from types import * Environ = TypedDict(\"Environ\", { \"wsgi.version\": tuple[Literal[1], Literal[0]], \"wsgi.url_scheme\": Literal[\"http\", \"https\"], \"wsgi.input\": IO, # Read only \"wsgi.errors\": IO, # Write only \"wsgi.multithread\": bool, \"wsgi.multiprocess\": bool, \"wsgi.run_once\": bool, }) class Write(Protocol): def __call__(self, body_data: bytes): ... class StartResponse(Protocol): type HeaderName = str type HeaderValue = str type ExcInfo = tuple[type[Exception], Exception, TracebackType] def __call__( self, status: str, response_headers: list[tuple[HeaderName, HeaderValue]], exc_info: ExcInfo | None = None ) -\u003e Write: ... class WsgiApp(Protocol): type ResponseBody = Iterable[bytes] def __call__(self, environ: dict, start_response: StartResponse) -\u003e ResponseBody: ... # do_somthing class WsgiMiddleware(WsgiApp): def __init__(self, app: WsgiApp): ... WSGI 앱이 요청을 처리하는 과정을 살펴보면 다음과 같습니다.\nenviron[‘wsgi.input’] 파일류 객체로 데이터를 읽습니다. 임의의 처리를 진행합니다. start_response 함수를 호출에서 응답을 시작합니다. 응답을 반환값으로 처리하거나(권장), start_response 가 반환한 파일류 객체로 응답을 직접 씁니다. WSGI의 영역에서 벗어나지만 WSGI 애플리케이션으로 Websocket 요청을 처리한다고 가정해봅시다. 웹소켓은 실시간 요청, 응답이 필요합니다. 즉, WSGI 애플리케이션에서 계속 읽기와 쓰기가 필요합니다. 먼저 읽기의 경우, 지속적 대기를 위해 무한루프 안에서 반복적으로 읽는 작업이 필요할 겁니다. 쓰기의 경우 권장되지 않는 방법이지만 start_response가 반환하는 쓰기 파일류 객체가 반드시 필요합니다.코드로 간단하게 나타내본다면 아래와 같은 느낌이죠. type Metadata = str def do_something(meta: Metadata, data: str) -\u003e str: ... def parse_data(data: str) -\u003e tuple[Metadata, str]: ... def should_finish(meta: Metadata): ... def wsgi(environ: dict, start_response: StartResponse) -\u003e Iterable[bytes]: readio = environ[\"wsgi.input\"] writeio = start_response(\"200 ok\", []) while True: try: if not (read := readio.read()): continue meta, data = parse_data(read) to_send = do_something(meta, data) writeio.write(to_send) if should_finish(meta): return [] except WebsocketDisconnect: return [] 이런 구조는 다음과 같은 문제가 생깁니다.\nWSGI 스펙과 거리가 있습니다. write 파일류 객체는 WSGI 표준에 포함된 사항이지만, 스펙 제안 이후에 새로 작성하는 코드에서는 사용하지 않는 것을 강력하게 권장하고 있습니다. 애플리케이션의 영역에서 다소 벗어납니다. 이 메시지가 어떤 종류의 메시지인지 애플리케이션이 직접 파싱해서 확인해야 합니다. 기존의 HTTP에서는 단일 요청 - 단일 응답 구조이기 때문에 어떤 메시지인지 확인할 필요가 없었습니다. 하지만 변화하는 환경에서는 추가로 데이터를 보낼지(websocket, 스트리밍), 연결이 끊어졌는지 등 추가로 확인해야 할 정보가 새로 생겼습니다. 게다가 이 정보들을 어떻게 .read() 에 어떻게 전달할지는 표준에 없기 때문에 애플리케이션 ASGI 서버별로 다른 구현을 하게 만듧니다. 이 외에도 클라이언트의 다음 데이터가 올 때까지 블록될 수 있는 문제와 그로 기인하는 자원 비효율성 문제가 있습니다. 그렇다면 ASGI는 이 문제를 어떻게 해결했을까요? ASGI가 문제를 해결한 방법 먼저 ASGI의 구조부터 살펴보겠습니다. ASGI는 크게 프로토콜 서버와 애플리케이션 두 가지로 구성되어 있습니다. 애플리케이션은 특정 파라미터 스펙(아래 AsgiApp 클래스 참조)를 가지는 Callable로 비즈니스 로직을 처리합니다. 서버는 애플리케이션이 하지 않는 모든 일을 처리합니다. 전체적인 구조는 WSGI와 동일하게 프로토콜 서버가 요청을 받으면 애플리케이션을 실행시키는 구조로 동작합니다.\nfrom typing import * class AsgiSpec(TypedDict): version: str, # If missing, assume 2.0 spec_version: Literal[\"2.0\", \"2.1\", \"2.2\", \"2.3\"] | None class Scope(TypedDict): type: str asgi: AsgiSpec class Receive(Protocol): class ReceiveEvent(TypedDict): type: str # Different by event type async def __call__(self) -\u003e ReceiveEvent: ... class Send(Protocol): class SendEvent(TypedDict): type: str # Different by event type async def __call__(self) -\u003e SendEvent: ... class AsgiApp(Protocol): async def __call__(self, scope: Scope, receive: Receive, send: Send): ... 일단 가장 큰 변경점은 ASGI의 목적대로 응답 - 요청의 단순한 1회성 라이프사이클이 아니라 유동적인 라이프사이클이 구현되었습니다. scope를 통해 연결 전체 정보를 얻고, receive와 send를 유동적으로 호출함으로서 언제, 몇 번, 데이터를 주고 받는지 애플리케이션이 간단한 API를 통해 자율적으로 조절할 수 있게 되었습니다. 이 구조는 통신의 기본적인 구조로 어디든 사용할 수 있습니다. 그래서 비록 표준에는 HTTP와 Websocket만 포함되어 있지만 다른 방식에도 쉽게 확장할 수 있습니다. HTTP가 아닌 AWS Lambda와의 인터페이스인 Magnum이 대표적입니다. ASGI의 확장을 목표로 하는 Django Channels 프로젝트도 있습니다.\n두 번째로는 async/await 문법과 코루틴의 사용입니다. 코루틴을 사용하면 클라이언트의 다음 데이터가 올 때만 실행되어 다음 데이터가 올 때까지 블록되는 문제를 해결할 수 있습니다. 좀 더 구체적인 설명은 이 글의 영역에서 벗어나므로 정확한 이유가 궁금하다면 python 이벤트 루프를 검색해보시기 바랍니다. 이 문제는 엄밀하게는 greenlet, tornado, twisted에서 async/await 없이 해결한 바가 있습니다만, 표준으로 들어왔다는 점에서 의미가 크죠.\n그 외로는 . 이 들어간 dict 키가 없다는 점이 눈에 띕니다. TypedDict 와 함께 사용하기 편하게 하기 위해 의도적으로 고려되지 않았나하고 조심스레 추측해봅니다.\nASGI 서버 살펴보기 마지막으로 ASGI 서버 구현을 살펴보면서 ASGI가 필요한 이유를 한 번 더 살펴보겠습니다.\n살펴보기 전에 ASGI 서버는 여러 종류가 있습니다. Hypercorn, Uvicorn, Daphne가 대표적입니다. AWS Lambda를 대상으로 한 Magnum도 있습니다. 이 글에서는 pure-python으로 작성된 Hypercorn에서 가장 간단한 프로토콜인 HTTP1.1을 살펴보겠습니다. 전체적인 흐름은 아래와 같습니다. 참조 코드는 너무 많은 관계로 일부만 가져왔습니다.\nasyncio.start_server -\u003e 연결을 처리할 Server 객체를 넘김 Server.__await__() -\u003e\nProtocol.initiate() -\u003e 연결 초기화\nserver._start_idle() -\u003e 타임아웃 설정\nserver._read_data() -\u003e 읽은 데이터를 Protocol에 넘기거나, 종료를 알림\nProtocolWrapper.handler() -\u003e Protocol.handle 호출\nProtocol.handle() -\u003e Connection 유한 상태 기계에 _handle_events를 호출해 처리하거나 종료.\nProtocol._handle_events() -\u003e 파싱 결과에 따라서 오류 응답을 보내거나 애플리케이션 실행\n서버를 시작하면서 응답 콜백을 넘깁니다. # https://github.com/pgjones/hypercorn/blob/33ed00670894b29ec00f4341a4ec5100e3ade747/src/hypercorn/asyncio/run.py ... def worker_serve(): ... def _server_callback( reader: asyncio.StreamReader, writer: asyncio.StreamWriter ): nonlocal server_tasks task = asyncio.current_task(loop) # 포스팅에 있는 코드에는 없는 내용이지만 # 서버 종료 시 처리중인 요청을 전부 처리하고 # 안정적인 종료를 위해 수집됩니다. server_tasks.add(task) task.add_done_callback(server_tasks.discard) await TCPServer(app, loop, config, context, reader, writer) ... servers.append( # 요청 시 _server_callback을 실행하게 됩니다. await asyncio.start_server( _server_callback, backlog=config.backlog, sock=sock ) ) ... 연결이 시작되면 타임아웃 콜백을 등록합니다. # https://github.com/pgjones/hypercorn/blob/main/src/hypercorn/asyncio/tcp_server.py#L70 # TCP Server 클래스의 메소드 일부 async def run(self) -\u003e None: # 주소, SSL 정보를 세팅합니다. socket = self.writer.get_extra_info(\"socket\") try: client = parse_socket_addr(socket.family, socket.getpeername()) server = parse_socket_addr(socket.family, socket.getsockname()) ssl_object = self.writer.get_extra_info(\"ssl_object\") if ssl_object is not None: ssl = True alpn_protocol = ssl_object.selected_alpn_protocol() else: ssl = False alpn_protocol = \"http/1.1\" async with TaskGroup(self.loop) as task_group: self.protocol = ProtocolWrapper( self.app, # ASGI 애플리케이션 self.config, self.context, task_group, ssl, client, server, self.protocol_send, alpn_protocol, ) # 프로토콜 초기화입니다. HTTP1.1의 경우 따로 무언가를 하지는 않습니다. await self.protocol.initiate() await self._start_idle() # 타임아웃 콜백을 등록합니다. await self._read_data() # 데이터를 읽고 프로토콜에 넘깁니다. except OSError: pass finally: await self._close() # 연결을 종료합니다. async def _read_data(self) -\u003e None: while not self.reader.at_eof(): # EOF로 요청 데이터가 끝일때까지 반복합니다. try: data = await asyncio.wait_for( self.reader.read(MAX_RECV), self.config.read_timeout ) except ( ConnectionError, OSError, asyncio.TimeoutError, TimeoutError, SSLError, ): break else: await self.protocol.handle(RawData(data)) await self.protocol.handle(Closed()) # 더 이상 요청이 없으므로 종료합니다. 데이터를 읽고 파싱합니다. 파싱 결과에 따라 애플리케이션을 실행하거나 오류 응답을 보냅니다. # https://github.com/pgjones/hypercorn/blob/main/src/hypercorn/protocol/h11.py # H11Protocol 클래스의 일부 async def handle(self, event: Event) -\u003e None: if isinstance(event, RawData): self.connection.receive_data(event.data) # 파서에 데이터를 먹이고 파싱합니다. await self._handle_events() elif isinstance(event, Closed): if self.stream is not None: await self._close_stream() async def _handle_events(self) -\u003e None: while True: if self.connection.they_are_waiting_for_100_continue: await self._send_h11_event( h11.InformationalResponse( status_code=100, headers=self.config.response_headers(\"h11\") ) ) try: event = self.connection.next_event() # 파싱 결과를 받아옵니다. except h11.RemoteProtocolError: if self.connection.our_state in {h11.IDLE, h11.SEND_RESPONSE}: await self._send_error_response(400) await self.send(Closed()) break else: if isinstance(event, h11.Request): await self.send(Updated(idle=False)) # HTTP1.1 그대로 사용하는지, 업그레이드 필요한지 확인합니다. # HTTP2 업그레이드는 ProtocolWrapper가 아래 _check_protocol에서 # 던진 에러를 받아서 처리합니다. await self._check_protocol(event) # Websocket으로 스트림 업그레이드를 하거나 HTTP 스트림을 설정합니다. await self._create_stream(event) # 흐름 제어. 연결 재사용과 관련되어 있습니다. # https://h11.readthedocs.io/en/latest/api.html elif event is h11.PAUSED: await self.can_read.clear() await self.can_read.wait() elif isinstance(event, h11.ConnectionClosed) or event is h11.NEED_DATA: break elif self.stream is None: break elif isinstance(event, h11.Data): await self.stream.handle(Body(stream_id=STREAM_ID, data=event.data)) elif isinstance(event, h11.EndOfMessage): await self.stream.handle(EndBody(stream_id=STREAM_ID)) elif isinstance(event, Data): # WebSocket pass through await self.stream.handle(event) 종합적으로 살펴보면 서버가 하는 일은 다음과 같습니다.\n네트워크 연결 관리 초기화(핸드셰이크) 타임아웃 처리 흐름 제어 연결 종료 프로토콜 관리 프로토콜 업그레이드 잘못된 요청에 대한 오류 응답 태스크 관리 안정적인 종료(Graceful Shutdown) 이벤트 루프 구현체별 래퍼 하는 일이 많은 것을 보아하니 ASGI 존재의의가 명확하게 보이는군요. 마무리 지금까지 ASGI의 도입 배경과 존재 의의에 대해 알아보았습니다. 더 자세한 이야기가 궁금하신 분들은 아래 참조 링크를 확인해주세요. 감사합니다.\n참조 PEP3333 : Python Web Server Gateway Interface v1.0.1 mod_wsgi ASGI(Asynchronous Server Gateway Interface) PEP3156 : Asynchronous IO Support Rebooted: the “asyncio” Module hypercorn github Will asgi become a PEP like wsgi is ? ","wordCount":"1417","inLanguage":"en","datePublished":"2023-12-24T21:03:30+09:00","dateModified":"2023-12-24T21:03:30+09:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://maintain0404.github.io/posts/asgi_deep_dive.ko/"},"publisher":{"@type":"Organization","name":"Taein.dev","logo":{"@type":"ImageObject","url":"https://maintain0404.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://maintain0404.github.io/ accesskey=h title="Taein.dev (Alt + H)"><img src=https://maintain0404.github.io/apple-touch-icon.png alt aria-label=logo height=35>Taein.dev</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://maintain0404.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://maintain0404.github.io/archives title=archives><span>archives</span></a></li><li><a href=https://maintain0404.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://maintain0404.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://maintain0404.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ASGI 깊게 살펴보기</h1><div class=post-meta><span title='2023-12-24 21:03:30 +0900 KST'>December 24, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1417 words&nbsp;·&nbsp;Me</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#개요>개요</a></li><li><a href=#wsgi를-두고-asgi를-새로-만든-이유>WSGI를 두고 ASGI를 새로 만든 이유</a></li><li><a href=#asgi가-문제를-해결한-방법>ASGI가 문제를 해결한 방법</a></li><li><a href=#asgi-서버-살펴보기>ASGI 서버 살펴보기</a><ul><li><a href=#살펴보기-전에>살펴보기 전에</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=개요>개요<a hidden class=anchor aria-hidden=true href=#개요>#</a></h2><p>이 글에서는 ASGI 도입 배경과 프로토콜을 분석해봅니다. 추가적으로 ASGI 프로토콜 서버 구현을 살펴보면서 ASGI의 필요성을 따져봅니다.
아래 지식을 가지고 있으면 이 글을 읽는 데에 도움이 됩니다.</p><ul><li>Python 문법(3.12 기준)</li><li>비동기 프로그래밍과 코루틴</li><li>HTTP</li><li>기타 서버 개발 관련 지식</li></ul><h2 id=wsgi를-두고-asgi를-새로-만든-이유>WSGI를 두고 ASGI를 새로 만든 이유<a hidden class=anchor aria-hidden=true href=#wsgi를-두고-asgi를-새로-만든-이유>#</a></h2><p>WSGI(Web Server Gateway Interface)는 ASGI 이전에 사용하던 Python의 웹 서버와 웹 애플리케이션 프레임워크 간의 인터페이스입니다. 이전의 프로토콜의 버전 업그레이드가 아니라 새롭게 인터페이스를 정의한 이유는 무엇일까요?
ASGI 공식 문서에서는 다음과 같이 설명하고 있습니다.</p><blockquote><p>The WSGI specification has worked well since it was introduced, and allowed for great flexibility in Python framework and web server choice. However, its design is irrevocably tied to the HTTP-style request/response cycle, and more and more protocols that do not follow this pattern are becoming a standard part of web programming (most notably, WebSocket).
ASGI attempts to preserve a simple application interface, while providing an abstraction that allows for data to be sent and received at any time, and from different application threads or processes.</p></blockquote><p>줄이자면 기존의 WSGI는 HTTP 스타일의 요청-응답 구조에 너무 맞춰져 있어서 새로운 웹 트렌드 변화(Websocket, HTTP/2)에 대응하기 어렵다는 것입니다 한 번 WSGI 구조를 살펴보겠습니다. 아래는 WSGI 문서를 참조해서 프로토콜을 type hint로 작성한 예시입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>types</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Environ</span> <span class=o>=</span> <span class=n>TypedDict</span><span class=p>(</span><span class=s2>&#34;Environ&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.version&#34;</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>Literal</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>Literal</span><span class=p>[</span><span class=mi>0</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.url_scheme&#34;</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;https&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.input&#34;</span><span class=p>:</span> <span class=n>IO</span><span class=p>,</span>  <span class=c1># Read only</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.errors&#34;</span><span class=p>:</span> <span class=n>IO</span><span class=p>,</span>  <span class=c1># Write only</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.multithread&#34;</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.multiprocess&#34;</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wsgi.run_once&#34;</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>                
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Write</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>body_data</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StartResponse</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span> <span class=n>HeaderName</span> <span class=o>=</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span> <span class=n>HeaderValue</span> <span class=o>=</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span> <span class=n>ExcInfo</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>type</span><span class=p>[</span><span class=ne>Exception</span><span class=p>],</span> <span class=ne>Exception</span><span class=p>,</span> <span class=n>TracebackType</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>response_headers</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>HeaderName</span><span class=p>,</span> <span class=n>HeaderValue</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>        <span class=n>exc_info</span><span class=p>:</span> <span class=n>ExcInfo</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Write</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WsgiApp</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span> <span class=n>ResponseBody</span> <span class=o>=</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>bytes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>environ</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>start_response</span><span class=p>:</span> <span class=n>StartResponse</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseBody</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span> <span class=c1># do_somthing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WsgiMiddleware</span><span class=p>(</span><span class=n>WsgiApp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>app</span><span class=p>:</span> <span class=n>WsgiApp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span></code></pre></div><p>WSGI 앱이 요청을 처리하는 과정을 살펴보면 다음과 같습니다.</p><ol><li>environ[&lsquo;wsgi.input&rsquo;] 파일류 객체로 데이터를 읽습니다.</li><li>임의의 처리를 진행합니다.</li><li><code>start_response</code> 함수를 호출에서 응답을 시작합니다.</li><li>응답을 반환값으로 처리하거나(권장), <code>start_response</code> 가 반환한 파일류 객체로 응답을 직접 씁니다.
WSGI의 영역에서 벗어나지만 WSGI 애플리케이션으로 Websocket 요청을 처리한다고 가정해봅시다.
웹소켓은 실시간 요청, 응답이 필요합니다. 즉, WSGI 애플리케이션에서 계속 읽기와 쓰기가 필요합니다. 먼저 읽기의 경우, 지속적 대기를 위해 무한루프 안에서 반복적으로 읽는 작업이 필요할 겁니다. 쓰기의 경우 권장되지 않는 방법이지만 start_response가 반환하는 쓰기 파일류 객체가 반드시 필요합니다.코드로 간단하게 나타내본다면 아래와 같은 느낌이죠.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>type</span> <span class=n>Metadata</span> <span class=o>=</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>do_something</span><span class=p>(</span><span class=n>meta</span><span class=p>:</span> <span class=n>Metadata</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>Metadata</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_finish</span><span class=p>(</span><span class=n>meta</span><span class=p>:</span> <span class=n>Metadata</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>wsgi</span><span class=p>(</span><span class=n>environ</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>start_response</span><span class=p>:</span> <span class=n>StartResponse</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>readio</span> <span class=o>=</span> <span class=n>environ</span><span class=p>[</span><span class=s2>&#34;wsgi.input&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>writeio</span> <span class=o>=</span> <span class=n>start_response</span><span class=p>(</span><span class=s2>&#34;200 ok&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>read</span> <span class=o>:=</span> <span class=n>readio</span><span class=o>.</span><span class=n>read</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>meta</span><span class=p>,</span> <span class=n>data</span> <span class=o>=</span> <span class=n>parse_data</span><span class=p>(</span><span class=n>read</span><span class=p>)</span>            
</span></span><span class=line><span class=cl>            <span class=n>to_send</span> <span class=o>=</span> <span class=n>do_something</span><span class=p>(</span><span class=n>meta</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>writeio</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>to_send</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>should_finish</span><span class=p>(</span><span class=n>meta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>WebsocketDisconnect</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><p>이런 구조는 다음과 같은 문제가 생깁니다.</p><ol><li>WSGI 스펙과 거리가 있습니다.
write 파일류 객체는 WSGI 표준에 포함된 사항이지만, 스펙 제안 이후에 새로 작성하는 코드에서는 사용하지 않는 것을 강력하게 권장하고 있습니다.</li><li>애플리케이션의 영역에서 다소 벗어납니다.
이 메시지가 어떤 종류의 메시지인지 애플리케이션이 직접 파싱해서 확인해야 합니다. 기존의 HTTP에서는 단일 요청 - 단일 응답 구조이기 때문에 어떤 메시지인지 확인할 필요가 없었습니다. 하지만 변화하는 환경에서는 추가로 데이터를 보낼지(websocket, 스트리밍), 연결이 끊어졌는지 등 추가로 확인해야 할 정보가 새로 생겼습니다. 게다가 이 정보들을 어떻게 <code>.read()</code> 에 어떻게 전달할지는 표준에 없기 때문에 애플리케이션 ASGI 서버별로 다른 구현을 하게 만듧니다.
이 외에도 클라이언트의 다음 데이터가 올 때까지 블록될 수 있는 문제와 그로 기인하는 자원 비효율성 문제가 있습니다. 그렇다면 ASGI는 이 문제를 어떻게 해결했을까요?</li></ol><h2 id=asgi가-문제를-해결한-방법>ASGI가 문제를 해결한 방법<a hidden class=anchor aria-hidden=true href=#asgi가-문제를-해결한-방법>#</a></h2><p>먼저 ASGI의 구조부터 살펴보겠습니다. ASGI는 크게 프로토콜 서버와 애플리케이션 두 가지로 구성되어 있습니다. 애플리케이션은 특정 파라미터 스펙(아래 AsgiApp 클래스 참조)를 가지는 Callable로 비즈니스 로직을 처리합니다. 서버는 애플리케이션이 하지 않는 모든 일을 처리합니다. 전체적인 구조는 WSGI와 동일하게 프로토콜 서버가 요청을 받으면 애플리케이션을 실행시키는 구조로 동작합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsgiSpec</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># If missing, assume 2.0                                 </span>
</span></span><span class=line><span class=cl>    <span class=n>spec_version</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=s2>&#34;2.1&#34;</span><span class=p>,</span> <span class=s2>&#34;2.2&#34;</span><span class=p>,</span> <span class=s2>&#34;2.3&#34;</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scope</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>asgi</span><span class=p>:</span> <span class=n>AsgiSpec</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Receive</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>ReceiveEvent</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>        <span class=c1># Different by event type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReceiveEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Send</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>SendEvent</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>        <span class=c1># Different by event type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>SendEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsgiApp</span><span class=p>(</span><span class=n>Protocol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>scope</span><span class=p>:</span> <span class=n>Scope</span><span class=p>,</span> <span class=n>receive</span><span class=p>:</span> <span class=n>Receive</span><span class=p>,</span> <span class=n>send</span><span class=p>:</span> <span class=n>Send</span><span class=p>):</span> 
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span></code></pre></div><p>일단 가장 큰 변경점은 ASGI의 목적대로 응답 - 요청의 단순한 1회성 라이프사이클이 아니라 유동적인 라이프사이클이 구현되었습니다. <code>scope</code>를 통해 연결 전체 정보를 얻고, <code>receive</code>와 <code>send</code>를 유동적으로 호출함으로서 언제, 몇 번, 데이터를 주고 받는지 애플리케이션이 간단한 API를 통해 자율적으로 조절할 수 있게 되었습니다. 이 구조는 통신의 기본적인 구조로 어디든 사용할 수 있습니다. 그래서 비록 표준에는 HTTP와 Websocket만 포함되어 있지만 다른 방식에도 쉽게 확장할 수 있습니다. HTTP가 아닌 AWS Lambda와의 인터페이스인 <a href=https://mangum.io/>Magnum</a>이 대표적입니다. ASGI의 확장을 목표로 하는 <a href=https://channels.readthedocs.io/en/stable/introduction.html#routing-and-multiple-protocols>Django Channels</a> 프로젝트도 있습니다.</p><p>두 번째로는 async/await 문법과 코루틴의 사용입니다. 코루틴을 사용하면 클라이언트의 다음 데이터가 올 때만 실행되어 다음 데이터가 올 때까지 블록되는 문제를 해결할 수 있습니다. 좀 더 구체적인 설명은 이 글의 영역에서 벗어나므로 정확한 이유가 궁금하다면 python 이벤트 루프를 검색해보시기 바랍니다. 이 문제는 엄밀하게는 greenlet, tornado, twisted에서 async/await 없이 해결한 바가 있습니다만, 표준으로 들어왔다는 점에서 의미가 크죠.</p><p>그 외로는 <code>.</code> 이 들어간 <code>dict</code> 키가 없다는 점이 눈에 띕니다. <code>TypedDict</code> 와 함께 사용하기 편하게 하기 위해 의도적으로 고려되지 않았나하고 조심스레 추측해봅니다.</p><h2 id=asgi-서버-살펴보기>ASGI 서버 살펴보기<a hidden class=anchor aria-hidden=true href=#asgi-서버-살펴보기>#</a></h2><p>마지막으로 ASGI 서버 구현을 살펴보면서 ASGI가 필요한 이유를 한 번 더 살펴보겠습니다.</p><h3 id=살펴보기-전에>살펴보기 전에<a hidden class=anchor aria-hidden=true href=#살펴보기-전에>#</a></h3><p>ASGI 서버는 여러 종류가 있습니다. <a href=https://github.com/pgjones/hypercorn>Hypercorn</a>, <a href=https://github.com/encode/uvicorn>Uvicorn</a>, <a href=https://github.com/django/daphne>Daphne</a>가 대표적입니다. AWS Lambda를 대상으로 한 <code>Magnum</code>도 있습니다. 이 글에서는 pure-python으로 작성된 Hypercorn에서 가장 간단한 프로토콜인 HTTP1.1을 살펴보겠습니다. 전체적인 흐름은 아래와 같습니다. 참조 코드는 너무 많은 관계로 일부만 가져왔습니다.</p><blockquote><p><code>asyncio.start_server</code> -> 연결을 처리할 Server 객체를 넘김
<code>Server.__await__()</code> -><br><code>Protocol.initiate()</code> -> 연결 초기화<br><code>server._start_idle()</code> -> 타임아웃 설정<br><code>server._read_data()</code> -> 읽은 데이터를 Protocol에 넘기거나, 종료를 알림<br><code>ProtocolWrapper.handler()</code> -> Protocol.handle 호출<br><code>Protocol.handle()</code> -> Connection 유한 상태 기계에 <code>_handle_events</code>를 호출해 처리하거나 종료.<br><code>Protocol._handle_events()</code> -> 파싱 결과에 따라서 오류 응답을 보내거나 애플리케이션 실행</p></blockquote><ol><li>서버를 시작하면서 응답 콜백을 넘깁니다.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># https://github.com/pgjones/hypercorn/blob/33ed00670894b29ec00f4341a4ec5100e3ade747/src/hypercorn/asyncio/run.py</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>worker_serve</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_server_callback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>reader</span><span class=p>:</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>StreamReader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=p>:</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>StreamWriter</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>nonlocal</span> <span class=n>server_tasks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>task</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>current_task</span><span class=p>(</span><span class=n>loop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 포스팅에 있는 코드에는 없는 내용이지만</span>
</span></span><span class=line><span class=cl>        <span class=c1># 서버 종료 시 처리중인 요청을 전부 처리하고</span>
</span></span><span class=line><span class=cl>        <span class=c1># 안정적인 종료를 위해 수집됩니다.</span>
</span></span><span class=line><span class=cl>        <span class=n>server_tasks</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>task</span><span class=o>.</span><span class=n>add_done_callback</span><span class=p>(</span><span class=n>server_tasks</span><span class=o>.</span><span class=n>discard</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>TCPServer</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>loop</span><span class=p>,</span> <span class=n>config</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>reader</span><span class=p>,</span> <span class=n>writer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>servers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1># 요청 시 _server_callback을 실행하게 됩니다.</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>start_server</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>_server_callback</span><span class=p>,</span> <span class=n>backlog</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>backlog</span><span class=p>,</span> <span class=n>sock</span><span class=o>=</span><span class=n>sock</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></div><ol start=2><li>연결이 시작되면 타임아웃 콜백을 등록합니다.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># https://github.com/pgjones/hypercorn/blob/main/src/hypercorn/asyncio/tcp_server.py#L70</span>
</span></span><span class=line><span class=cl><span class=c1># TCP Server 클래스의 메소드 일부</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 주소, SSL 정보를 세팅합니다.</span>
</span></span><span class=line><span class=cl>    <span class=n>socket</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>writer</span><span class=o>.</span><span class=n>get_extra_info</span><span class=p>(</span><span class=s2>&#34;socket&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>parse_socket_addr</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>family</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>getpeername</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span> <span class=o>=</span> <span class=n>parse_socket_addr</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>family</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>getsockname</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>ssl_object</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>writer</span><span class=o>.</span><span class=n>get_extra_info</span><span class=p>(</span><span class=s2>&#34;ssl_object&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ssl_object</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ssl</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>alpn_protocol</span> <span class=o>=</span> <span class=n>ssl_object</span><span class=o>.</span><span class=n>selected_alpn_protocol</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ssl</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=n>alpn_protocol</span> <span class=o>=</span> <span class=s2>&#34;http/1.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=n>TaskGroup</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=p>)</span> <span class=k>as</span> <span class=n>task_group</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=n>ProtocolWrapper</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>app</span><span class=p>,</span>  <span class=c1># ASGI 애플리케이션</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>task_group</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ssl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>server</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>protocol_send</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>alpn_protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 프로토콜 초기화입니다. HTTP1.1의 경우 따로 무언가를 하지는 않습니다.</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span><span class=o>.</span><span class=n>initiate</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_start_idle</span><span class=p>()</span>  <span class=c1># 타임아웃 콜백을 등록합니다.</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_data</span><span class=p>()</span>  <span class=c1># 데이터를 읽고 프로토콜에 넘깁니다.</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_close</span><span class=p>()</span>  <span class=c1># 연결을 종료합니다.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>_read_data</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>reader</span><span class=o>.</span><span class=n>at_eof</span><span class=p>():</span>  <span class=c1># EOF로 요청 데이터가 끝일때까지 반복합니다.</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>MAX_RECV</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>read_timeout</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=ne>ConnectionError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=ne>OSError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=ne>TimeoutError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SSLError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>RawData</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>Closed</span><span class=p>())</span>  <span class=c1># 더 이상 요청이 없으므로 종료합니다.</span>
</span></span></code></pre></div><ol start=3><li>데이터를 읽고 파싱합니다. 파싱 결과에 따라 애플리케이션을 실행하거나 오류 응답을 보냅니다.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># https://github.com/pgjones/hypercorn/blob/main/src/hypercorn/protocol/h11.py</span>
</span></span><span class=line><span class=cl><span class=c1># H11Protocol 클래스의 일부</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>RawData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>receive_data</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>  <span class=c1># 파서에 데이터를 먹이고 파싱합니다.</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>Closed</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_close_stream</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>_handle_events</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>they_are_waiting_for_100_continue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_send_h11_event</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>h11</span><span class=o>.</span><span class=n>InformationalResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>status_code</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>response_headers</span><span class=p>(</span><span class=s2>&#34;h11&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>next_event</span><span class=p>()</span>  <span class=c1># 파싱 결과를 받아옵니다.</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>h11</span><span class=o>.</span><span class=n>RemoteProtocolError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>our_state</span> <span class=ow>in</span> <span class=p>{</span><span class=n>h11</span><span class=o>.</span><span class=n>IDLE</span><span class=p>,</span> <span class=n>h11</span><span class=o>.</span><span class=n>SEND_RESPONSE</span><span class=p>}:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_send_error_response</span><span class=p>(</span><span class=mi>400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>Closed</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>h11</span><span class=o>.</span><span class=n>Request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>Updated</span><span class=p>(</span><span class=n>idle</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=c1># HTTP1.1 그대로 사용하는지, 업그레이드 필요한지 확인합니다.</span>
</span></span><span class=line><span class=cl>                <span class=c1># HTTP2 업그레이드는 ProtocolWrapper가 아래 _check_protocol에서</span>
</span></span><span class=line><span class=cl>                <span class=c1># 던진 에러를 받아서 처리합니다.</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_protocol</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># Websocket으로 스트림 업그레이드를 하거나 HTTP 스트림을 설정합니다.</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_stream</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 흐름 제어. 연결 재사용과 관련되어 있습니다.</span>
</span></span><span class=line><span class=cl>            <span class=c1># https://h11.readthedocs.io/en/latest/api.html</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>event</span> <span class=ow>is</span> <span class=n>h11</span><span class=o>.</span><span class=n>PAUSED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>can_read</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>can_read</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>h11</span><span class=o>.</span><span class=n>ConnectionClosed</span><span class=p>)</span> <span class=ow>or</span> <span class=n>event</span> <span class=ow>is</span> <span class=n>h11</span><span class=o>.</span><span class=n>NEED_DATA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>h11</span><span class=o>.</span><span class=n>Data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>Body</span><span class=p>(</span><span class=n>stream_id</span><span class=o>=</span><span class=n>STREAM_ID</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>h11</span><span class=o>.</span><span class=n>EndOfMessage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>EndBody</span><span class=p>(</span><span class=n>stream_id</span><span class=o>=</span><span class=n>STREAM_ID</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>Data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># WebSocket pass through</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   
</span></span></code></pre></div><p>종합적으로 살펴보면 서버가 하는 일은 다음과 같습니다.</p><ol><li>네트워크 연결 관리<ol><li>초기화(핸드셰이크)</li><li>타임아웃 처리</li><li>흐름 제어</li><li>연결 종료</li></ol></li><li>프로토콜 관리<ol><li>프로토콜 업그레이드</li><li>잘못된 요청에 대한 오류 응답</li></ol></li><li>태스크 관리<ol><li>안정적인 종료(Graceful Shutdown)</li><li>이벤트 루프 구현체별 래퍼
하는 일이 많은 것을 보아하니 ASGI 존재의의가 명확하게 보이는군요.</li></ol></li></ol><h1 id=마무리>마무리<a hidden class=anchor aria-hidden=true href=#마무리>#</a></h1><p>지금까지 ASGI의 도입 배경과 존재 의의에 대해 알아보았습니다. 더 자세한 이야기가 궁금하신 분들은 아래 참조 링크를 확인해주세요. 감사합니다.</p><h1 id=참조>참조<a hidden class=anchor aria-hidden=true href=#참조>#</a></h1><ul><li><a href=https://peps.python.org/pep-3333/#original-rationale-and-goals-from-pep-333>PEP3333 : Python Web Server Gateway Interface v1.0.1</a></li><li><a href=https://modwsgi.readthedocs.io/en/master/configuration-directives/WSGIChunkedRequest.html>mod_wsgi</a></li><li><a href=https://asgi.readthedocs.io/en/latest/specs/main.html>ASGI(Asynchronous Server Gateway Interface)</a></li><li><a href>PEP3156 : Asynchronous IO Support Rebooted: the &ldquo;asyncio&rdquo; Module</a></li><li><a href=https://github.com/pgjones/hypercorn>hypercorn github</a></li><li><a href=https://groups.google.com/g/django-developers/c/ktTPNUTlsM0>Will asgi become a PEP like wsgi is ?</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://maintain0404.github.io/tags/python/>python</a></li><li><a href=https://maintain0404.github.io/tags/asgi/>ASGI</a></li></ul><nav class=paginav><a class=prev href=https://maintain0404.github.io/posts/reflex_review.ko/><span class=title>« Prev</span><br><span>Reflex 사용 후 느낀 점(with 간단한 팁)</span>
</a><a class=next href=https://maintain0404.github.io/posts/resource_managing_in_software.ko/><span class=title>Next »</span><br><span>소트트웨어에서 여러 작업 흐름을 관리하는 다양한 방법</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on x" href="https://x.com/intent/tweet/?text=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0&amp;url=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f&amp;hashtags=python%2cASGI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f&amp;title=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0&amp;summary=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0&amp;source=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f&title=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on whatsapp" href="https://api.whatsapp.com/send?text=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0%20-%20https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on telegram" href="https://telegram.me/share/url?text=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0&amp;url=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ASGI 깊게 살펴보기 on ycombinator" href="https://news.ycombinator.com/submitlink?t=ASGI%20%ea%b9%8a%ea%b2%8c%20%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0&u=https%3a%2f%2fmaintain0404.github.io%2fposts%2fasgi_deep_dive.ko%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=maintain0404/blog issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://maintain0404.github.io/>Taein.dev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>